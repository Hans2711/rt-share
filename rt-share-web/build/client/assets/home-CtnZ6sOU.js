import{w as he}from"./with-props-DB8Vr4zk.js";import{r as c,n as s}from"./chunk-D4RADZKF-l-Tz34VA.js";function ye(){return Math.floor(1e4+Math.random()*9e4).toString()}function ee(d){if(d<1024)return`${d} B`;const S=["KB","MB","GB","TB"];let l=-1,i=d;do i/=1024,l++;while(i>=1024&&l<S.length-1);return`${i.toFixed(1)} ${S[l]}`}function pe({currentUser:d,targetUser:S,messages:l,onSendMessage:i,onSendFile:u,sendInfo:b={progress:null},receiveInfo:j={progress:null},connectionStatus:v}){const[x,E]=c.useState(""),O=()=>{const f=x.trim();f&&(console.log(f),i(f),E(""))},g=f=>{var F;const R=(F=f.target.files)==null?void 0:F[0];R&&(console.log("Sending File",R),u(R),f.target.value="")},z=v==="connected"?"text-green-500 dark:text-green-600":v==="connecting"||v==="reconnecting"?"text-amber-500 dark:text-amber-600":"text-red-700 dark:text-red-800";return s.jsxs("div",{className:"flex flex-col h-full bg-gray-100 dark:bg-gray-800",children:[s.jsxs("h2",{className:"p-4 m-0 bg-gray-100 border-b border-gray-300 dark:bg-gray-700 dark:border-gray-800",children:["Chat with ",S,s.jsx("span",{className:`ml-2 text-sm ${z}`,children:v==="connected"?"Connected":v==="reconnecting"?"Reconnecting...":v==="connecting"?"Connecting...":"Disconnected"})]}),s.jsx("hr",{}),b.progress!==null&&s.jsxs("div",{className:"p-2",children:[s.jsxs("div",{children:["Sending ",b.filename," (",b.size?ee(b.size):"",")… ",b.progress,"%"]}),s.jsx("progress",{value:b.progress??0,max:100,className:"w-full"})]}),j.progress!==null&&s.jsxs("div",{className:"p-2",children:[s.jsxs("div",{children:["Receiving ",j.filename," (",j.size?ee(j.size):"",")… ",j.progress,"%"]}),s.jsx("progress",{value:j.progress??0,max:100,className:"w-full"})]}),s.jsx("div",{className:"flex-1 p-4 overflow-y-auto dark:bg-gray-800",children:l.map(f=>s.jsxs("div",{className:`mb-2 p-2 rounded-lg max-w-[70%] break-words ${f.sender===d?"bg-green-500/20 ml-auto dark:bg-green-600 dark:text-white":"bg-gray-100 mr-auto dark:bg-gray-700 dark:text-gray-300"}`,children:[s.jsx("div",{className:"text-xs text-gray-500 mb-1 dark:text-gray-300",children:f.sender===d?"You":f.sender}),f.isFile?s.jsx("div",{className:"file-message",children:f.filename}):s.jsx("div",{className:"text-message",children:f.text})]},f.id))}),s.jsx("div",{className:"p-2 flex flex-col gap-2 bg-gray-100 dark:bg-gray-700 md:p-4 md:gap-3",children:s.jsxs("div",{className:"flex gap-2 md:gap-3",children:[s.jsx("input",{type:"text",value:x,onChange:f=>E(f.target.value),onKeyPress:f=>f.key==="Enter"&&O(),placeholder:"Type a message...",className:"flex-1 p-2 text-sm border border-gray-300 rounded dark:bg-gray-700 dark:text-gray-300 dark:border-gray-800"}),s.jsx("button",{onClick:O,className:"px-3 py-2 text-sm bg-green-500 text-white rounded hover:bg-green-600 dark:bg-green-600",children:"Send"}),s.jsx("label",{htmlFor:"file",className:"px-3 py-2 text-sm bg-green-500 text-white rounded cursor-pointer hover:bg-green-600 dark:bg-green-600",children:"Send File"}),s.jsx("input",{type:"file",name:"file",id:"file",onChange:g,className:"hidden"})]})})]})}function xe({users:d,currentUser:S,selectedUser:l,isOnline:i,onSelect:u,onShowHistory:b}){var O;const[j,v]=c.useState(!1),x=(O=d.find(g=>g.id===S))==null?void 0:O.ip,E=i?d.filter(g=>g.id!==S).length===0?"No Users":`Users (You are ${S})`:"Waiting for Connection";return s.jsxs("div",{className:"relative w-full bg-gray-100 border-b border-gray-300 overflow-y-auto md:w-[250px] md:border-b-0 md:border-r dark:bg-gray-800 dark:border-gray-800 pb-14",children:[s.jsx("h2",{className:"p-4 m-0 bg-gray-100 border-b border-gray-300 dark:bg-gray-700 dark:border-gray-800",children:E}),s.jsxs("label",{className:"border-b border-gray-300 w-full p-3 dark:border-gray-800 flex items-center justify-between gap-2 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700",children:[s.jsx("span",{children:"Local Only"}),s.jsx("input",{type:"checkbox",checked:j,onChange:()=>v(g=>!g),className:"form-checkbox h-5 w-5 text-blue-600"})]}),s.jsx("ul",{className:"list-none p-0 m-0",children:d.filter(g=>g.id!==S).filter(g=>!j||x&&g.ip===x).map(g=>s.jsxs("li",{className:`p-3 cursor-pointer border-b border-gray-300 hover:bg-gray-100 dark:border-gray-800 dark:hover:bg-gray-700 ${l===g.id?"bg-gray-300 font-bold dark:bg-gray-700 dark:text-gray-100":""} ${g.isOnline?"":"opacity-50"}`,onClick:()=>u(g.id),children:[g.id," ",!g.isOnline&&"(Offline)"]},g.id))}),s.jsx("button",{onClick:b,className:"absolute bottom-2 left-1/2 -translate-x-1/2 md:left-auto md:right-2 md:translate-x-0 px-3 py-2 text-sm bg-green-500 text-white rounded",children:"Files"})]})}function be({files:d,onClose:S}){const l=i=>{const u=URL.createObjectURL(i.blob),b=Object.assign(document.createElement("a"),{href:u,download:i.filename,style:"display:none"});document.body.appendChild(b).click(),document.body.removeChild(b),URL.revokeObjectURL(u)};return s.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:s.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded shadow w-full max-w-sm max-h-full overflow-y-auto p-4",children:[s.jsx("h2",{className:"text-lg font-bold mb-2",children:"Received Files"}),d.length===0?s.jsx("p",{className:"text-sm",children:"No files yet."}):s.jsx("ul",{className:"divide-y divide-gray-300 dark:divide-gray-700",children:d.map((i,u)=>s.jsxs("li",{className:"py-2 flex items-center justify-between gap-2",children:[s.jsxs("span",{className:"text-sm break-all flex-1",children:[i.sender?`${i.sender}: `:"",i.filename]}),s.jsx("button",{onClick:()=>l(i),className:"px-2 py-1 text-xs bg-green-500 text-white rounded",children:"Download"})]},u))}),s.jsx("button",{onClick:S,className:"mt-4 w-full px-3 py-2 text-sm bg-gray-200 rounded dark:bg-gray-700 dark:text-gray-200",children:"Close"})]})})}function we(){const[d,S]=c.useState(""),l=c.useRef(null),i=c.useRef({}),u=c.useRef({}),b=c.useRef(0),[j,v]=c.useState([]),[x,E]=c.useState(null),O=c.useRef(null),[g,z]=c.useState({}),[f,R]=c.useState(!1),[F,T]=c.useState(!1),[Y,_]=c.useState(""),[te,$]=c.useState(null),[ne,A]=c.useState(null),[P,G]=c.useState(null),[J,X]=c.useState(null),[re,se]=c.useState({}),[ae,Z]=c.useState(!1),[oe,U]=c.useState({}),q=c.useRef({}),Q=c.useRef({}),B=c.useRef({}),D=c.useRef([]),L=c.useRef(!1),N=(e,n)=>{U(t=>({...t,[e]:n}))};c.useEffect(()=>{O.current=x},[x]),c.useEffect(()=>{D.current=j},[j]),c.useEffect(()=>{L.current=f},[f]);const ce=16*1024;c.useEffect(()=>{const e=setInterval(()=>{Object.entries(i.current).forEach(([n,t])=>{let r="connecting";switch(t.connectionState){case"connected":r="connected";break;case"disconnected":case"failed":r="reconnecting";break;case"new":case"connecting":r="connecting";break;case"closed":r="disconnected";break}N(n,r)})},500);return()=>clearInterval(e)},[]);const M=c.useRef({}),W=()=>{Object.values(u.current).forEach(e=>{try{e.close()}catch{}}),Object.values(i.current).forEach(e=>{try{e.close()}catch{}}),i.current={},u.current={},U({})},ie=e=>{E(e);const n=D.current.some(r=>r.id===e&&r.isOnline);if(!L.current||!n){N(e,"disconnected");return}N(e,"connecting");const t=d>e;C(e,t)};c.useEffect(()=>{let e=localStorage.getItem("sessionId");if(e||(e=ye(),localStorage.setItem("sessionId",e)),S(e),!l.current||l.current.readyState===WebSocket.CLOSED){const n=window.location.protocol==="https:"?"wss":"ws",t=window.location.hostname,r=new WebSocket(`${n}://${t}:3000/`);return l.current=r,T(!0),setTimeout(()=>{r.readyState!==WebSocket.OPEN&&(_("Connection timed out."),T(!1),setTimeout(()=>window.location.reload(),3e3))},8e3),r.onopen=()=>{console.log("WebSocket connection established"),T(!1),R(!0),r.send(JSON.stringify({type:"join",payload:e})+`
`)},r.addEventListener("error",m=>{_("WebSocket connection error "+m),R(!1),setTimeout(()=>window.location.reload(),3e3)}),r.onclose=()=>{R(!1),W()},r.onmessage=m=>{var p,k;const a=JSON.parse(m.data);if(console.log("Received event:",a),a.type==="join"&&a.status==="ok"){const o=JSON.parse(a.data);v(o.map(h=>({...h,isOnline:!0}))),o.forEach(h=>{if(h.id!==e){const y=e>h.id;C(h.id,y)}})}else if(a.type==="join"&&a.status==="userJoin"){const o=a.data,h=a.ip;if(v(y=>y.some(w=>w.id===o)?y.map(w=>w.id===o?{...w,isOnline:!0,ip:h}:w):[...y,{id:o,ip:h,isOnline:!0}]),o!==e){const y=e>o;C(o,y)}}else if(a.type==="leave"&&a.status==="userLeft"){const o=a.data;v(h=>h.map(y=>y.id===o?{...y,isOnline:!1}:y)),N(o,"disconnected");try{(p=u.current[o])==null||p.close()}catch{}try{(k=i.current[o])==null||k.close()}catch{}delete u.current[o],delete i.current[o]}else a.type==="offer"&&a.status==="forward"?le(a.sender,a.data):a.type==="answer"&&a.status==="forward"?de(a.sender,a.data):a.type==="candidate"&&a.status==="forward"&&fe(a.sender,a.data)},()=>{W(),l.current&&l.current.readyState===WebSocket.OPEN&&(l.current.send(JSON.stringify({type:"leave",payload:e})+`
`),l.current.close()),l.current=null}}},[]);const V=(e,n)=>{n.binaryType="arraybuffer",u.current[e]=n,n.onopen=()=>N(e,"connected"),n.onclose=()=>{delete u.current[e];try{const r=i.current[e];r&&r.close()}catch{}delete i.current[e];const t=D.current.some(r=>r.id===e&&r.isOnline);if(L.current&&t){N(e,"reconnecting");const r=500+Math.floor(Math.random()*500);setTimeout(()=>{i.current[e]||C(e)},r)}else N(e,"disconnected")},n.onmessage=t=>{var r,m;if(O.current!==e&&E(e),typeof t.data=="string"){let a;try{a=JSON.parse(t.data)}catch{return}if(a.type==="text"){const p={id:Date.now().toString(),text:a.text,sender:e,timestamp:new Date};z(k=>({...k,[e]:[...k[e]||[],p]}))}else if(a.type==="file-offer")if(Q.current[e])n.send(JSON.stringify({type:"file-accept"}));else if(window.confirm(`Accept '${a.filename}' (${a.size} B) from ${e}?`))Q.current[e]=!0,n.send(JSON.stringify({type:"file-accept"}));else{n.send(JSON.stringify({type:"file-deny"}));return}else if(a.type==="file-meta")(r=M.current)[e]??(r[e]={}),M.current[e][a.filename]={size:a.size,received:0,chunks:[]},X({name:a.filename,size:a.size}),A(0);else if(a.type==="file-accept"){q.current[e]=!0;const p=B.current[e];p&&(B.current[e]=null,I(e,p))}else if(a.type==="file-deny")B.current[e]=null,alert(`${e} rejected the file transfer.`);else if(a.type==="file-end"){const p=(m=M.current[e])==null?void 0:m[a.filename];if(!p)return;const k=new Blob(p.chunks),o=URL.createObjectURL(k),h=Object.assign(document.createElement("a"),{href:o,download:a.filename,style:"display:none"});document.body.appendChild(h).click(),document.body.removeChild(h),URL.revokeObjectURL(o),se(w=>({...w,[e]:[...w[e]||[],{filename:a.filename,blob:k}]}));const y={id:Date.now().toString(),text:"",sender:e,timestamp:new Date,isFile:!0,filename:a.filename};z(w=>({...w,[e]:[...w[e]||[],y]})),delete M.current[e][a.filename],A(null),X(null)}return}if(t.data instanceof ArrayBuffer||t.data instanceof Blob){(t.data instanceof Blob?t.data.arrayBuffer():Promise.resolve(t.data)).then(p=>{const k=M.current[e],o=k&&Object.values(k)[0];o&&(o.chunks.push(p),o.received+=p.byteLength,A(Math.floor(o.received/o.size*100)))});return}console.warn("Unrecognised datachannel frame:",t.data)}},C=(e,n=d>e)=>{if(i.current[e])return;if(!L.current||!D.current.some(r=>r.id===e&&r.isOnline)){N(e,"disconnected");return}U(r=>({...r,[e]:r[e]==="reconnecting"?"reconnecting":"connecting"}));const t=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun2.l.google.com:19302"}]});if(i.current[e]=t,t.onconnectionstatechange=()=>{if(t.connectionState==="connected")N(e,"connected");else if(t.connectionState==="failed"||t.connectionState==="disconnected"){if(b.current+=1,b.current>=10){window.location.reload();return}console.warn("Peer connection dropped",e);try{t.close()}catch{}delete i.current[e],delete u.current[e];const r=D.current.some(m=>m.id===e&&m.isOnline);if(L.current&&r){N(e,"reconnecting");const m=1e3+Math.floor(Math.random()*1e3);setTimeout(()=>{i.current[e]||C(e)},m)}else N(e,"disconnected")}},t.onicecandidate=r=>{r.candidate&&l.current&&l.current.send(JSON.stringify({type:"candidate",payload:e,text:JSON.stringify(r.candidate)})+`
`)},t.ondatachannel=r=>V(e,r.channel),n){const r=t.createDataChannel("chat");V(e,r),t.createOffer().then(m=>t.setLocalDescription(m)).then(()=>{l.current&&t.localDescription&&l.current.send(JSON.stringify({type:"offer",payload:e,text:JSON.stringify(t.localDescription)})+`
`)})}},le=(e,n)=>{C(e,!1);const t=i.current[e];if(!t||t.signalingState!=="stable"){console.warn("Ignoring unexpected offer in state",t==null?void 0:t.signalingState);return}t.setRemoteDescription(new RTCSessionDescription(JSON.parse(n))).then(()=>t.createAnswer()).then(r=>t.setLocalDescription(r)).then(()=>{l.current&&t.localDescription&&l.current.send(JSON.stringify({type:"answer",payload:e,text:JSON.stringify(t.localDescription)})+`
`)})},de=(e,n)=>{const t=i.current[e];t&&t.signalingState==="have-local-offer"&&t.setRemoteDescription(new RTCSessionDescription(JSON.parse(n)))},fe=(e,n)=>{const t=i.current[e];t&&t.addIceCandidate(new RTCIceCandidate(JSON.parse(n)))},H=e=>{const n=u.current[e];return!n||n.readyState!=="open"?(L.current&&D.current.some(t=>t.id===e&&t.isOnline)?C(e):N(e,"disconnected"),!1):!0};c.useEffect(()=>{const e=setInterval(()=>{L.current&&D.current.forEach(n=>{if(n.id===d||!n.isOnline)return;const t=i.current[n.id],r=t==null?void 0:t.connectionState;if(!t||r==="closed"||r==="failed"||r==="disconnected"){const m=d>n.id;C(n.id,m)}})},2e3);return()=>clearInterval(e)},[d]);const ue=(e,n)=>{if(!H(e)){alert("Peer connection not established yet. Reconnecting...");return}u.current[e].send(JSON.stringify({type:"text",text:n}));const r={id:Date.now().toString(),text:n,sender:d,timestamp:new Date};z(m=>({...m,[e]:[...m[e]||[],r]}))},I=async(e,n)=>{if(!H(e)){alert("Peer connection not established yet. Reconnecting...");return}const t=u.current[e];console.debug(`Preparing to send '${n.name}' (${n.size} B)`);const r=16*1024*1024;t.bufferedAmountLowThreshold=4*1024*1024;const m=()=>new Promise(o=>{if(t.bufferedAmount<=t.bufferedAmountLowThreshold){o();return}const h=()=>{t.removeEventListener("bufferedamountlow",h),o()};t.addEventListener("bufferedamountlow",h)});t.send(JSON.stringify({type:"file-meta",filename:n.name,size:n.size})),G({name:n.name,size:n.size});let a=0;$(0);const p=n.stream().getReader();for(;;){const{value:o,done:h}=await p.read();if(h)break;let y=0;for(;y<o.length;){const w=Math.min(y+ce,o.length),K=o.subarray(y,w);for(;t.bufferedAmount+K.byteLength>r;)await m();try{t.send(K)}catch(me){console.error("Failed to send chunk:",me),alert("File transfer aborted."),$(null);return}y=w,a+=K.byteLength,$(Math.floor(a/n.size*100))}}t.send(JSON.stringify({type:"file-end",filename:n.name})),$(null),G(null);const k={id:Date.now().toString(),text:"",sender:d,timestamp:new Date,isFile:!0,filename:n.name};z(o=>({...o,[e]:[...o[e]||[],k]}))},ge=(e,n)=>{if(q.current[e]){I(e,n);return}if(!H(e)){alert("Peer connection not established yet. Reconnecting...");return}const t=u.current[e];B.current[e]=n,t.send(JSON.stringify({type:"file-offer",filename:n.name,size:n.size}))};return c.useEffect(()=>{const e=()=>{(!l.current||l.current.readyState!==WebSocket.OPEN)&&window.location.reload()},n=()=>{R(!1),W()};return window.addEventListener("online",e),window.addEventListener("offline",n),()=>{window.removeEventListener("online",e),window.removeEventListener("offline",n)}},[]),s.jsxs("div",{className:"p-2 md:p-5 max-w-screen-xl mx-auto h-screen overflow-hidden",children:[s.jsxs("div",{className:"flex flex-col h-full border border-gray-300 rounded-lg overflow-hidden md:flex-row md:h-[80vh] dark:border-gray-800",children:[s.jsx(xe,{users:j,currentUser:d,selectedUser:x,isOnline:f,onSelect:ie,onShowHistory:()=>Z(!0)}),s.jsx("div",{className:"flex flex-col flex-1 min-h-[60vh] overflow-y-auto",children:F?s.jsx("div",{className:"flex items-center justify-center h-full text-gray-500 dark:text-gray-300",children:"Connecting..."}):Y?s.jsx("div",{className:"flex items-center justify-center h-full text-red-700 dark:text-red-800",children:s.jsxs("p",{children:["Error: ",Y]})}):x?s.jsx(pe,{currentUser:d,targetUser:x,messages:g[x]||[],sendInfo:{progress:te,filename:P==null?void 0:P.name,size:P==null?void 0:P.size},receiveInfo:{progress:ne,filename:J==null?void 0:J.name,size:J==null?void 0:J.size},connectionStatus:oe[x]||"disconnected",onSendMessage:e=>ue(x,e),onSendFile:e=>ge(x,e)}):s.jsx("div",{className:"flex items-center justify-center h-full text-gray-500 dark:text-gray-300",children:s.jsx("p",{children:"Select a user to start chatting"})})})]}),ae&&s.jsx(be,{files:Object.entries(re).flatMap(([e,n])=>n.map(t=>({...t,sender:e}))),onClose:()=>Z(!1)})]})}function ke({}){return[{title:"Real-time Share"},{name:"description",content:"Real-time file and text sharing"}]}const ve=he(function(){return s.jsx(we,{})});export{ve as default,ke as meta};
