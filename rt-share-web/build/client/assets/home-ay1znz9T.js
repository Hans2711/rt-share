import{w as D}from"./with-props-59htwGLe.js";import{r as u,l as t}from"./chunk-KNED5TY2-D5VDA_GO.js";const v=10;function R({currentUser:d,targetUser:N,ws:o,messages:y,onSendMessage:x,onSendFile:f}){const[j,w]=u.useState(""),g=()=>{const s=j.trim();s&&(console.log(s),x(s),w(""))},O=s=>{var h;const p=(h=s.target.files)==null?void 0:h[0];if(p){if(p.size>v*1024*1024){alert(`File too large. Max allowed is ${v}MB.`);return}f(p),s.target.value=""}};return t.jsxs("div",{className:"chat-container",children:[t.jsxs("h2",{children:["Chat with ",N]}),t.jsx("hr",{}),t.jsx("div",{className:"messages",children:y.map(s=>t.jsxs("div",{className:`message ${s.sender===d?"sent":"received"}`,children:[t.jsx("div",{className:"message-sender",children:s.sender===d?"You":s.sender}),s.isFile?t.jsx("div",{className:"file-message",children:t.jsx("a",{href:"#",onClick:p=>{if(p.preventDefault(),o){const h={type:"acceptFile",payload:s.sender};o.send(JSON.stringify(h)+`
`)}},children:s.filename})}):t.jsx("div",{className:"text-message",children:s.text})]},s.id))}),t.jsx("div",{className:"chat-input",children:t.jsxs("div",{className:"input-container",children:[t.jsx("input",{type:"text",value:j,onChange:s=>w(s.target.value),onKeyPress:s=>s.key==="Enter"&&g(),placeholder:"Type a message..."}),t.jsx("button",{onClick:g,children:"Send"}),t.jsx("label",{for:"file",className:"send-file",children:"Send File"}),t.jsx("input",{type:"file",name:"file",id:"file",onChange:O})]})})]})}function J(){return Math.floor(1e4+Math.random()*9e4).toString()}function E(){const[d,N]=u.useState(""),o=u.useRef(null),[y,x]=u.useState([]),[f,j]=u.useState(null),[w,g]=u.useState({}),[O,s]=u.useState(!1),[p,h]=u.useState(!1),[b,F]=u.useState("");u.useEffect(()=>{let e=localStorage.getItem("sessionId");if(e||(e=J(),localStorage.setItem("sessionId",e)),N(e),!o.current||o.current.readyState===WebSocket.CLOSED){const i=new WebSocket("wss://rt-share.diesing.pro:3000/");return o.current=i,h(!0),setTimeout(()=>{i.readyState!==WebSocket.OPEN&&(F("Connection timed out."),h(!1),setTimeout(()=>{window.location.reload()},3e3))},8e3),i.onopen=()=>{console.log("WebSocket connection established"),h(!1),s(!0);const r={type:"join",payload:e};i.send(JSON.stringify(r)+`
`)},i.addEventListener("error",r=>{F("WebSocket connection error "+r),s(!1),setTimeout(()=>{window.location.reload()},3e3)}),i.onmessage=r=>{const n=JSON.parse(r.data);if(console.log("Received event:",n),n.type==="join"&&n.status==="ok"){const a=JSON.parse(n.data);x(a.map(c=>({id:c,isOnline:!0})))}else if(n.type==="join"&&n.status==="userJoin"){const a=n.data;x(c=>c.find(l=>l.id===a)?c.map(l=>l.id===a?{...l,isOnline:!0}:l):[...c,{id:a,isOnline:!0}])}else if(n.type==="leave"&&n.status==="userLeft"){const a=n.data;x(c=>c.map(m=>m.id===a?{...m,isOnline:!1}:m))}else if(n.type==="sendText"&&n.status==="dataSend"){const a={id:Date.now().toString(),text:n.data,sender:n.sender,timestamp:new Date};g(c=>({...c,[n.sender]:[...c[n.sender]||[],a]}))}else n.type==="sendFile"&&n.status==="requestSendFile"?confirm(`Accept File ${n.filename} from ${n.data}`)?i.send(JSON.stringify({type:"acceptFile",payload:n.data})+`
`):i.send(JSON.stringify({type:"denyFile",payload:n.data})+`
`):n.type==="sendFile"&&n.status==="dataSend"&&I(n)},()=>{if(o.current&&o.current.readyState===WebSocket.OPEN){const r={type:"leave",payload:e};o.current.send(JSON.stringify(r)+`
`),o.current.close(),o.current=null}}}},[]);const I=e=>{const i=e.filename,r=e.bytes,n=atob(r),a=new Uint8Array(n.length);for(let S=0;S<n.length;S++)a[S]=n.charCodeAt(S);const c=new Blob([a]),m=URL.createObjectURL(c),l=document.createElement("a");if(l.href=m,l.download=i,l.style.display="none",document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(m),e.sender){const S={id:Date.now().toString(),text:"",sender:e.sender,timestamp:new Date,isFile:!0,filename:i};g(C=>({...C,[e.sender]:[...C[e.sender]||[],S]}))}},M=(e,i)=>{if(!o.current)return;console.log(i),console.log(e);const r={type:"sendText",payload:e,text:i};o.current.send(JSON.stringify(r)+`
`);const n={id:Date.now().toString(),text:i,sender:d,timestamp:new Date};g(a=>({...a,[e]:[...a[e]||[],n]}))},k=(e,i)=>{if(!o.current)return;const r=new FileReader;r.onload=function(){const n=r.result;if(!n)return;const a=Array.from(new Uint8Array(n)),c={type:"sendFile",payload:e,filename:i.name,bytes:a};o.current.send(JSON.stringify(c)+`
`);const m={id:Date.now().toString(),text:"",sender:d,timestamp:new Date,isFile:!0,filename:i.name};g(l=>({...l,[e]:[...l[e]||[],m]}))},r.readAsArrayBuffer(i)};return t.jsx("div",{className:"rt-share-container",children:t.jsxs("div",{className:"rt-share-layout",children:[t.jsxs("div",{className:"user-list",children:[t.jsx("h2",{children:O?y.filter(e=>e.id!==d).length===0?"No Users":"Users (You are "+d+")":"Waiting for Connection"}),t.jsx("ul",{children:y.filter(e=>e.id!==d).map(e=>t.jsxs("li",{className:`${f===e.id?"selected":""} ${e.isOnline?"":"offline"}`,onClick:()=>j(e.id),children:[e.id," ",!e.isOnline&&"(Offline)"]},e.id))})]}),t.jsx("div",{className:"chat-area",children:p?t.jsx("div",{className:"loading no-chat-selected",children:"Connecting..."}):b?t.jsx("div",{className:"error no-chat-selected",children:t.jsxs("p",{children:["Error: ",b]})}):f?t.jsx(R,{currentUser:d,targetUser:f,ws:o.current,messages:w[f]||[],online:y.some(e=>e.id===f&&e.isOnline),onSendMessage:e=>M(f,e),onSendFile:e=>k(f,e)}):t.jsx("div",{className:"no-chat-selected",children:t.jsx("p",{children:"Select a user to start chatting"})})})]})})}function U({}){return[{title:"Real-time Share"},{name:"description",content:"Real-time file and text sharing"}]}const W=D(function(){return t.jsx(E,{})});export{W as default,U as meta};
