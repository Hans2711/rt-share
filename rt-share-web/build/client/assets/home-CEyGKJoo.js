import{w as O}from"./with-props-59htwGLe.js";import{r as h,l as n}from"./chunk-KNED5TY2-D5VDA_GO.js";function F({currentUser:c,targetUser:N,ws:r,messages:g,onSendMessage:S,onSendFile:f}){const[x,j]=h.useState(""),m=()=>{const t=x.trim();t&&(console.log(t),S(t),j(""))},w=t=>{var e;const p=(e=t.target.files)==null?void 0:e[0];p&&(f(p),t.target.value="")};return n.jsxs("div",{className:"chat-container",children:[n.jsxs("h2",{children:["Chat with ",N]}),n.jsx("hr",{}),n.jsx("div",{className:"messages",children:g.map(t=>n.jsxs("div",{className:`message ${t.sender===c?"sent":"received"}`,children:[n.jsx("div",{className:"message-sender",children:t.sender===c?"You":t.sender}),t.isFile?n.jsx("div",{className:"file-message",children:n.jsx("a",{href:"#",onClick:p=>{if(p.preventDefault(),r){const e={type:"acceptFile",payload:t.sender};r.send(JSON.stringify(e)+`
`)}},children:t.filename})}):n.jsx("div",{className:"text-message",children:t.text})]},t.id))}),n.jsx("div",{className:"chat-input",children:n.jsxs("div",{className:"input-container",children:[n.jsx("input",{type:"text",value:x,onChange:t=>j(t.target.value),onKeyPress:t=>t.key==="Enter"&&m(),placeholder:"Type a message..."}),n.jsx("button",{onClick:m,children:"Send"}),n.jsx("label",{for:"file",className:"send-file",children:"Send File"}),n.jsx("input",{type:"file",name:"file",id:"file",onChange:w})]})})]})}function v(){return Math.floor(1e4+Math.random()*9e4).toString()}function C(){const[c,N]=h.useState(""),r=h.useRef(null),[g,S]=h.useState([]),[f,x]=h.useState(null),[j,m]=h.useState({});h.useEffect(()=>{let e=localStorage.getItem("sessionId");if(e||(e=v(),localStorage.setItem("sessionId",e)),N(e),!r.current||r.current.readyState===WebSocket.CLOSED){const i=new WebSocket("wss://rt-share.diesing.pro:3000/");return r.current=i,i.onopen=()=>{console.log("WebSocket connection established");const d={type:"join",payload:e};i.send(JSON.stringify(d)+`
`)},i.onmessage=d=>{const s=JSON.parse(d.data);if(console.log("Received event:",s),s.type==="join"&&s.status==="ok"){const a=JSON.parse(s.data);S(a.map(o=>({id:o,isOnline:!0})))}else if(s.type==="join"&&s.status==="userJoin"){const a=s.data;S(o=>o.find(l=>l.id===a)?o.map(l=>l.id===a?{...l,isOnline:!0}:l):[...o,{id:a,isOnline:!0}])}else if(s.type==="leave"&&s.status==="userLeft"){const a=s.data;S(o=>o.map(u=>u.id===a?{...u,isOnline:!1}:u))}else if(s.type==="sendText"&&s.status==="dataSend"){const a={id:Date.now().toString(),text:s.data,sender:s.sender,timestamp:new Date};m(o=>({...o,[s.sender]:[...o[s.sender]||[],a]}))}else s.type==="sendFile"&&s.status==="requestSendFile"?confirm(`Accept File ${s.filename} from ${s.data}`)?i.send(JSON.stringify({type:"acceptFile",payload:s.data})+`
`):i.send(JSON.stringify({type:"denyFile",payload:s.data})+`
`):s.type==="sendFile"&&s.status==="dataSend"&&w(s)},()=>{if(r.current&&r.current.readyState===WebSocket.OPEN){const d={type:"leave",payload:e};r.current.send(JSON.stringify(d)+`
`),r.current.close(),r.current=null}}}},[]);const w=e=>{const i=e.filename,d=e.bytes,s=atob(d),a=new Uint8Array(s.length);for(let y=0;y<s.length;y++)a[y]=s.charCodeAt(y);const o=new Blob([a]),u=URL.createObjectURL(o),l=document.createElement("a");if(l.href=u,l.download=i,l.style.display="none",document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(u),e.sender){const y={id:Date.now().toString(),text:"",sender:e.sender,timestamp:new Date,isFile:!0,filename:i};m(b=>({...b,[e.sender]:[...b[e.sender]||[],y]}))}},t=(e,i)=>{if(!r.current)return;console.log(i),console.log(e);const d={type:"sendText",payload:e,text:i};r.current.send(JSON.stringify(d)+`
`);const s={id:Date.now().toString(),text:i,sender:c,timestamp:new Date};m(a=>({...a,[e]:[...a[e]||[],s]}))},p=(e,i)=>{if(!r.current)return;const d=new FileReader;d.onload=function(){const s=d.result;if(!s)return;const a=Array.from(new Uint8Array(s)),o={type:"sendFile",payload:e,filename:i.name,bytes:a};r.current.send(JSON.stringify(o)+`
`);const u={id:Date.now().toString(),text:"",sender:c,timestamp:new Date,isFile:!0,filename:i.name};m(l=>({...l,[e]:[...l[e]||[],u]}))},d.readAsArrayBuffer(i)};return n.jsxs("div",{className:"rt-share-container",children:[n.jsx("h2",{class:"mb-3",children:c}),n.jsxs("div",{className:"rt-share-layout",children:[n.jsxs("div",{className:"user-list",children:[n.jsx("h2",{children:g.filter(e=>e.id!==c).length===0?"No Users":"Users"}),n.jsx("ul",{children:g.filter(e=>e.id!==c).map(e=>n.jsxs("li",{className:`${f===e.id?"selected":""} ${e.isOnline?"":"offline"}`,onClick:()=>x(e.id),children:[e.id," ",!e.isOnline&&"(Offline)"]},e.id))})]}),n.jsx("div",{className:"chat-area",children:f?n.jsx(F,{currentUser:c,targetUser:f,ws:r.current,messages:j[f]||[],online:g.some(e=>e.id===f&&e.isOnline),onSendMessage:e=>t(f,e),onSendFile:e=>p(f,e)}):n.jsx("div",{className:"no-chat-selected",children:n.jsx("p",{children:"Select a user to start chatting"})})})]})]})}function I({}){return[{title:"Real-time Share"},{name:"description",content:"Real-time file and text sharing"}]}const R=O(function(){return n.jsx(C,{})});export{R as default,I as meta};
