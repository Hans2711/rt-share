import{w as q}from"./with-props-59htwGLe.js";import{r as u,l as s}from"./chunk-KNED5TY2-D5VDA_GO.js";function G({currentUser:m,targetUser:y,messages:c,onSendMessage:h,onSendFile:g,sendProgress:x=null,receiveProgress:l=null}){const[p,N]=u.useState(""),v=()=>{const r=p.trim();r&&(console.log(r),h(r),N(""))},E=r=>{var O;const b=(O=r.target.files)==null?void 0:O[0];b&&(console.log("Sending File",b),g(b),r.target.value="")};return s.jsxs("div",{className:"chat-container",children:[s.jsxs("h2",{children:["Chat with ",y]}),s.jsx("hr",{}),x!==null&&s.jsxs("div",{className:"progress-container",children:[s.jsxs("div",{children:["Sending file… ",x,"%"]}),s.jsx("progress",{value:x,max:100})]}),l!==null&&s.jsxs("div",{className:"progress-container",children:[s.jsxs("div",{children:["Receiving file… ",l,"%"]}),s.jsx("progress",{value:l,max:100})]}),s.jsx("div",{className:"messages",children:c.map(r=>s.jsxs("div",{className:`message ${r.sender===m?"sent":"received"}`,children:[s.jsx("div",{className:"message-sender",children:r.sender===m?"You":r.sender}),r.isFile?s.jsx("div",{className:"file-message",children:r.filename}):s.jsx("div",{className:"text-message",children:r.text})]},r.id))}),s.jsx("div",{className:"chat-input",children:s.jsxs("div",{className:"input-container",children:[s.jsx("input",{type:"text",value:p,onChange:r=>N(r.target.value),onKeyPress:r=>r.key==="Enter"&&v(),placeholder:"Type a message..."}),s.jsx("button",{onClick:v,children:"Send"}),s.jsx("label",{htmlFor:"file",className:"send-file",children:"Send File"}),s.jsx("input",{type:"file",name:"file",id:"file",onChange:E})]})})]})}function Q({users:m,currentUser:y,selectedUser:c,isOnline:h,onSelect:g}){const x=h?m.filter(l=>l.id!==y).length===0?"No Users":`Users (You are ${y})`:"Waiting for Connection";return s.jsxs("div",{className:"user-list",children:[s.jsx("h2",{children:x}),s.jsx("ul",{children:m.filter(l=>l.id!==y).map(l=>s.jsxs("li",{className:`${c===l.id?"selected":""} ${l.isOnline?"":"offline"}`,onClick:()=>g(l.id),children:[l.id," ",!l.isOnline&&"(Offline)"]},l.id))})]})}function V(){return Math.floor(1e4+Math.random()*9e4).toString()}function I(){const[m,y]=u.useState(""),c=u.useRef(null),h=u.useRef({}),g=u.useRef({}),[x,l]=u.useState([]),[p,N]=u.useState(null),v=u.useRef(null),[E,r]=u.useState({}),[b,O]=u.useState(!1),[U,k]=u.useState(!1),[M,P]=u.useState(""),[B,D]=u.useState(null),[A,J]=u.useState(null);u.useEffect(()=>{v.current=p},[p]);const z=16*1024,C=u.useRef({}),W=()=>{Object.values(g.current).forEach(e=>{try{e.close()}catch{}}),Object.values(h.current).forEach(e=>{try{e.close()}catch{}}),h.current={},g.current={}},$=e=>{N(e),L(e,!0)};u.useEffect(()=>{let e=localStorage.getItem("sessionId");if(e||(e=V(),localStorage.setItem("sessionId",e)),y(e),!c.current||c.current.readyState===WebSocket.CLOSED){const a=new WebSocket("ws://localhost:3000/");return c.current=a,k(!0),setTimeout(()=>{a.readyState!==WebSocket.OPEN&&(P("Connection timed out."),k(!1),setTimeout(()=>window.location.reload(),3e3))},8e3),a.onopen=()=>{console.log("WebSocket connection established"),k(!1),O(!0),a.send(JSON.stringify({type:"join",payload:e})+`
`)},a.addEventListener("error",t=>{P("WebSocket connection error "+t),O(!1),setTimeout(()=>window.location.reload(),3e3)}),a.onmessage=t=>{const n=JSON.parse(t.data);if(console.log("Received event:",n),n.type==="join"&&n.status==="ok"){const f=JSON.parse(n.data);l(f.map(i=>({id:i,isOnline:!0})))}else if(n.type==="join"&&n.status==="userJoin"){const f=n.data;l(i=>i.some(o=>o.id===f)?i.map(o=>o.id===f?{...o,isOnline:!0}:o):[...i,{id:f,isOnline:!0}])}else if(n.type==="leave"&&n.status==="userLeft"){const f=n.data;l(i=>i.map(o=>o.id===f?{...o,isOnline:!1}:o))}else n.type==="offer"&&n.status==="forward"?H(n.sender,n.data):n.type==="answer"&&n.status==="forward"?K(n.sender,n.data):n.type==="candidate"&&n.status==="forward"&&Y(n.sender,n.data)},()=>{W(),c.current&&c.current.readyState===WebSocket.OPEN&&(c.current.send(JSON.stringify({type:"leave",payload:e})+`
`),c.current.close()),c.current=null}}},[]);const T=(e,a)=>{a.binaryType="arraybuffer",g.current[e]=a,a.onmessage=t=>{var n,f;if(v.current!==e&&N(e),typeof t.data=="string"){let i;try{i=JSON.parse(t.data)}catch{return}if(i.type==="text"){const o={id:Date.now().toString(),text:i.text,sender:e,timestamp:new Date};r(S=>({...S,[e]:[...S[e]||[],o]}))}else if(i.type==="file-meta")(n=C.current)[e]??(n[e]={}),C.current[e][i.filename]={size:i.size,received:0,chunks:[]},J(0);else if(i.type==="file-end"){const o=(f=C.current[e])==null?void 0:f[i.filename];if(!o)return;const S=new Blob(o.chunks),d=URL.createObjectURL(S),w=Object.assign(document.createElement("a"),{href:d,download:i.filename,style:"display:none"});document.body.appendChild(w).click(),document.body.removeChild(w),URL.revokeObjectURL(d);const j={id:Date.now().toString(),text:"",sender:e,timestamp:new Date,isFile:!0,filename:i.filename};r(R=>({...R,[e]:[...R[e]||[],j]})),delete C.current[e][i.filename],J(null)}return}if(t.data instanceof ArrayBuffer||t.data instanceof Blob){(t.data instanceof Blob?t.data.arrayBuffer():Promise.resolve(t.data)).then(o=>{const S=C.current[e],d=S&&Object.values(S)[0];d&&(d.chunks.push(o),d.received+=o.byteLength,J(Math.floor(d.received/d.size*100)))});return}console.warn("Unrecognised datachannel frame:",t.data)}},L=(e,a)=>{if(h.current[e])return;const t=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});if(h.current[e]=t,t.onconnectionstatechange=()=>{if(t.connectionState==="failed"||t.connectionState==="disconnected"){console.warn("Peer connection dropped",e);try{t.close()}catch{}delete h.current[e],delete g.current[e],setTimeout(()=>{h.current[e]||L(e,a)},1e3)}},t.onicecandidate=n=>{n.candidate&&c.current&&c.current.send(JSON.stringify({type:"candidate",payload:e,text:JSON.stringify(n.candidate)})+`
`)},t.ondatachannel=n=>T(e,n.channel),a){const n=t.createDataChannel("chat");T(e,n),t.createOffer().then(f=>t.setLocalDescription(f)).then(()=>{c.current&&t.localDescription&&c.current.send(JSON.stringify({type:"offer",payload:e,text:JSON.stringify(t.localDescription)})+`
`)})}},H=(e,a)=>{L(e,!1);const t=h.current[e];t.setRemoteDescription(new RTCSessionDescription(JSON.parse(a))).then(()=>t.createAnswer()).then(n=>t.setLocalDescription(n)).then(()=>{c.current&&t.localDescription&&c.current.send(JSON.stringify({type:"answer",payload:e,text:JSON.stringify(t.localDescription)})+`
`)})},K=(e,a)=>{const t=h.current[e];t&&t.setRemoteDescription(new RTCSessionDescription(JSON.parse(a)))},Y=(e,a)=>{const t=h.current[e];t&&t.addIceCandidate(new RTCIceCandidate(JSON.parse(a)))},_=(e,a)=>{const t=g.current[e];if(!t||t.readyState!=="open"){alert("Peer connection not established yet.");return}t.send(JSON.stringify({type:"text",text:a}));const n={id:Date.now().toString(),text:a,sender:m,timestamp:new Date};r(f=>({...f,[e]:[...f[e]||[],n]}))},X=async(e,a)=>{const t=g.current[e];if(!t||t.readyState!=="open"){alert("Peer connection not established yet.");return}console.debug(`Preparing to send '${a.name}' (${a.size} B)`);const n=16*1024*1024;t.bufferedAmountLowThreshold=4*1024*1024;const f=()=>new Promise(d=>{if(t.bufferedAmount<=t.bufferedAmountLowThreshold){d();return}const w=()=>{t.removeEventListener("bufferedamountlow",w),d()};t.addEventListener("bufferedamountlow",w)});t.send(JSON.stringify({type:"file-meta",filename:a.name,size:a.size}));let i=0;D(0);const o=a.stream().getReader();for(;;){const{value:d,done:w}=await o.read();if(w)break;let j=0;for(;j<d.length;){const R=Math.min(j+z,d.length),F=d.subarray(j,R);for(;t.bufferedAmount+F.byteLength>n;)await f();try{t.send(F)}catch(Z){console.error("Failed to send chunk:",Z),alert("File transfer aborted."),D(null);return}j=R,i+=F.byteLength,D(Math.floor(i/a.size*100))}}t.send(JSON.stringify({type:"file-end",filename:a.name})),D(null);const S={id:Date.now().toString(),text:"",sender:m,timestamp:new Date,isFile:!0,filename:a.name};r(d=>({...d,[e]:[...d[e]||[],S]}))};return s.jsx("div",{className:"rt-share-container",children:s.jsxs("div",{className:"rt-share-layout",children:[s.jsx(Q,{users:x,currentUser:m,selectedUser:p,isOnline:b,onSelect:$}),s.jsx("div",{className:"chat-area",children:U?s.jsx("div",{className:"loading no-chat-selected",children:"Connecting..."}):M?s.jsx("div",{className:"error no-chat-selected",children:s.jsxs("p",{children:["Error: ",M]})}):p?s.jsx(G,{currentUser:m,targetUser:p,messages:E[p]||[],sendProgress:B,receiveProgress:A,onSendMessage:e=>_(p,e),onSendFile:e=>X(p,e)}):s.jsx("div",{className:"no-chat-selected",children:s.jsx("p",{children:"Select a user to start chatting"})})})]})})}function ne({}){return[{title:"Real-time Share"},{name:"description",content:"Real-time file and text sharing"}]}const se=q(function(){return s.jsx(I,{})});export{se as default,ne as meta};
